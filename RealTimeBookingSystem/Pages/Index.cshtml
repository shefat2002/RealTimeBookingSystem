@page
@model IndexModel
@{
    ViewData["Title"] = "Real-time Booking";
}

<style>
    .main-layout {
        display: flex;
        gap: 20px;
    }
    
    .game-area {
        flex: 2;
    }
    
    .dashboard {
        flex: 1;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }

    .grid-container {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        margin-top: 20px;
    }

    .block {
        height: 60px;
        background-color: #4CAF50; /* Green = Available */
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 5px;
        font-weight: bold;
        transition: transform 0.1s;
        font-size: 12px;
        text-align: center;
        word-break: break-word;
        flex-direction: column;
    }

    .block:hover {
        transform: scale(1.05);
    }

    /* Style for booked blocks */
    .block.taken {
        background-color: #F44336 !important; /* Red = Taken */
        cursor: not-allowed;
        pointer-events: none; /* Disable clicks */
    }

    .block.reward {
        background-color: #FFD700 !important; /* Gold = Reward */
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        animation: glow 2s ease-in-out infinite alternate;
    }

    @@keyframes glow {
        from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        to { box-shadow: 0 0 30px rgba(255, 215, 0, 1); }
    }
    
    .block-owner {
        font-size: 10px;
        opacity: 0.9;
    }

    #login-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .login-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        min-width: 300px;
    }

    #game-status {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
    }

    .status-waiting { background-color: #17a2b8; color: white; }
    .status-countdown { background-color: #ffc107; color: black; }
    .status-active { background-color: #28a745; color: white; }
    .status-revealing { background-color: #6f42c1; color: white; }
    .status-finished { background-color: #6c757d; color: white; }

    #countdown-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .countdown-number {
        font-size: 200px;
        color: #FFD700;
        font-weight: bold;
        text-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
    }

    .winner-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(45deg, #FFD700, #FFA500);
        padding: 20px 40px;
        border-radius: 15px;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        z-index: 3000;
        display: none;
        text-align: center;
        color: #000;
        font-weight: bold;
        border: 3px solid #FF6347;
    }
</style>

<div id="login-screen">
    <div class="login-box">
        <h2>Join Game</h2>
        <div class="form-group mb-3">
            <input type="text" id="username-input" class="form-control" placeholder="Enter your name" />
        </div>
        <button class="btn btn-primary w-100" onclick="joinGame()">Join</button>
    </div>
</div>

<div class="text-center">
    <h1 class="display-4">Block Booking System</h1>
    <p>Welcome, <span id="current-user-display" class="fw-bold">Guest</span>! Click a green block to book it.</p>
    
    <div id="game-status" class="status-waiting">
        <span id="status-text">Waiting for players... (Need 10 players to auto-start)</span>
    </div>
    
    <button id="start-btn" class="btn btn-success" onclick="startGame()" style="margin: 10px; display: none;">Start Game</button>
    <button class="btn btn-danger" onclick="resetAll()" style="margin: 10px;">Reset All Blocks</button>
</div>

<div id="countdown-overlay">
    <div class="countdown-number" id="countdown-number"></div>
</div>

<div id="winner-notification" class="winner-notification">
    <h3 id="winner-title">üéâ Congratulations! üéâ</h3>
    <p id="winner-message"></p>
</div>

<div class="main-layout">
    <div class="game-area">
        <div class="grid-container">
            @for (int i = 1; i <= Model.TotalBlocks; i++)
            {
                var isTaken = Model.BookedBlocks.ContainsKey(i);
                var owner = isTaken ? Model.BookedBlocks[i] : "";
                var takenClass = isTaken ? "taken" : "";
                
                <div id="block-@i" class="block @takenClass" onclick="bookBlock(@i)" data-owner="@owner">
                    <span>@i</span>
                    @if(isTaken) { <span class="block-owner">@owner</span> }
                </div>
            }
        </div>
    </div>
    
    <div class="dashboard">
        <h4>Online Users (<span id="online-count">0</span>)</h4>
        <ul id="user-list" class="list-group mb-4"></ul>
        
        <h4>Leaderboard</h4>
        <ul id="leaderboard" class="list-group"></ul>
    </div>
</div>

<!-- Include SignalR Client Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    let currentUser = "";
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/bookingHub")
        .build();

    // 1. Handle Login
    function joinGame() {
        const input = document.getElementById('username-input');
        const name = input.value.trim();
        if (!name) return alert("Please enter a name");
        
        currentUser = name;
        document.getElementById('current-user-display').innerText = currentUser;
        document.getElementById('login-screen').style.display = 'none';
        
        // Connect to SignalR and announce presence
        startConnection();
    }

    async function startConnection() {
        try {
            await connection.start();
            await connection.invoke("Join", currentUser);
        } catch (err) {
            console.error(err);
        }
    }

    // 2. Listen for events
    connection.on("BlockBooked", function (blockId, ownerName) {
        updateBlockUI(blockId, ownerName);
        updateLeaderboard();
    });

    connection.on("BatchBlockBooked", function (updates) {
        updates.forEach(u => {
            updateBlockUI(u.blockId, u.userName);
        });
        updateLeaderboard();
    });

    function updateBlockUI(blockId, ownerName) {
        const block = document.getElementById(`block-${blockId}`);
        if (block) {
            block.classList.add("taken");
            block.setAttribute("data-owner", ownerName);
            
            // Add owner name to block
            if (!block.querySelector('.block-owner')) {
                const span = document.createElement('span');
                span.className = 'block-owner';
                span.innerText = ownerName;
                block.appendChild(span);
            }
        }
    }

    connection.on("ResetAll", function () {
        document.querySelectorAll('.block').forEach(b => {
            b.classList.remove("taken");
            b.setAttribute("data-owner", "");
            const ownerSpan = b.querySelector('.block-owner');
            if (ownerSpan) ownerSpan.remove();
        });
        updateLeaderboard();
    });
    
    connection.on("UpdateUserList", function (users) {
        document.getElementById('online-count').innerText = users.length;
        const list = document.getElementById('user-list');
        list.innerHTML = users.map(u => `<li class="list-group-item">${u}</li>`).join('');
        
        // Update game status based on player count
        updateGameStatus(`${users.length}/10 players online`);
    });

    // Game event handlers
    connection.on("GameCountdown", function (count) {
        const overlay = document.getElementById('countdown-overlay');
        const number = document.getElementById('countdown-number');
        
        if (count > 0) {
            overlay.style.display = 'flex';
            number.innerText = count;
            updateGameStatus("Game starting...", "countdown");
        } else {
            number.innerText = "GO!";
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 1000);
        }
    });

    connection.on("GameStarted", function () {
        updateGameStatus("Game in progress! (1 minute remaining)", "active");
    });

    connection.on("GameEnded", function () {
        updateGameStatus("Game ended! Revealing rewards...", "revealing");
    });

    connection.on("RewardsRevealed", function (rewards) {
        rewards.forEach(reward => {
            const block = document.getElementById(`block-${reward.blockId}`);
            if (block) {
                block.classList.add('reward');
                const rewardSpan = document.createElement('div');
                rewardSpan.innerHTML = `<small>üéÅ ${reward.rewardType}<br>${reward.rewardValue}</small>`;
                block.appendChild(rewardSpan);
            }
        });
    });

    connection.on("WinnerNotification", function (userName, reward) {
        if (userName === currentUser) {
            showWinnerNotification(reward);
        }
    });

    connection.on("GameReset", function () {
        document.querySelectorAll('.block').forEach(b => {
            b.classList.remove("taken", "reward");
            b.setAttribute("data-owner", "");
            const extraElements = b.querySelectorAll('.block-owner, div');
            extraElements.forEach(el => el.remove());
        });
        updateGameStatus("Waiting for players...", "waiting");
        updateLeaderboard();
    });

    function updateGameStatus(text, state = "waiting") {
        const statusEl = document.getElementById('game-status');
        const textEl = document.getElementById('status-text');
        
        textEl.innerText = text;
        statusEl.className = `status-${state}`;
    }

    function showWinnerNotification(reward) {
        const notification = document.getElementById('winner-notification');
        const message = document.getElementById('winner-message');
        
        message.innerHTML = `You won a ${reward.rewardType} worth ${reward.rewardValue} points!<br>üéä Amazing! üéä`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }

    // 3. Logic
    async function bookBlock(id) {
        if (!currentUser) return;
        
        try {
            const response = await fetch(`/api/booking/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userName: currentUser })
            });

            if (!response.ok) {
                const data = await response.json();
                alert(data.message);
            }
        } catch (error) {
            console.error('Error booking block:', error);
        }
    }

    async function startGame() {
        try {
            const response = await fetch('/api/booking/start', { method: 'POST' });
            if (response.ok) {
                document.getElementById('start-btn').style.display = 'none';
            }
        } catch (error) {
            console.error('Error starting game:', error);
        }
    }

    async function resetAll() {
        if (!confirm("Are you sure you want to reset all bookings?")) return;
        try {
            await fetch('/api/booking/reset', { method: 'POST' });
        } catch (error) {
            console.error('Error resetting blocks:', error);
        }
    }
    
    function updateLeaderboard() {
        // Calculate leaderboard from current DOM state
        const counts = {};
        document.querySelectorAll('.block.taken').forEach(b => {
            const owner = b.getAttribute('data-owner');
            if (owner) counts[owner] = (counts[owner] || 0) + 1;
        });
        
        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
        
        const list = document.getElementById('leaderboard');
        list.innerHTML = sorted.map(([name, count]) => 
            `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${name}
                <span class="badge bg-primary rounded-pill">${count}</span>
            </li>`
        ).join('');
    }
    
    // Initial leaderboard calc
    updateLeaderboard();
</script>
